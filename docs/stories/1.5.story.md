# Story 1.5: Calculation History

## Status: Draft

## Story

As a user,
I want to view and manage my calculation history during a session,
so that I can reference previous calculations and track my work.

## Acceptance Criteria

1. Session history maintains all calculations performed during runtime
2. History display shows expressions, results, and timestamps
3. History navigation allows viewing previous calculations
4. History persistence across session with configurable limits
5. History export functionality for session data
6. History clear/reset functionality for new sessions

## Context Source

- Source Document: docs/prd/requirements.md (FR6: calculation history)
- Enhancement Type: Session management and data persistence
- Existing System Impact: Enhances CLI from Story 1.3 with history tracking

## Dev Notes

### Previous Story Insights

Story 1.4 enhances error handling for the CLI. This story adds calculation history functionality to provide users with session tracking and reference capabilities.

### Data Models

Use History and Calculation models from docs/architecture/data-models.md:

- **History**: Session management with calculations list, timestamps, size tracking
- **Calculation**: Individual calculation records with expression, result, operation details

### API Specifications

Extend CalculationEngine interface from docs/architecture/components.md with history management:

- AddHistory(calculation Calculation) error
- GetHistory() []Calculation
- ClearHistory() error
- ExportHistory(format string) ([]byte, error)

### Component Specifications

Implement history management following docs/architecture/backend-architecture.md:

- internal/history/manager.go - History session management
- internal/history/storage.go - In-memory storage with persistence
- internal/terminal/history.go - CLI history display and navigation

### File Locations

Following unified project structure from docs/architecture/unified-project-structure.md:

- History manager: internal/history/manager.go
- History storage: internal/history/storage.go
- History CLI: internal/terminal/history.go
- History models: internal/models/history.go, calculation.go
- History tests: test/unit/history/manager_test.go, storage_test.go
- Integration tests: test/integration/history_test.go

### Testing Requirements

Follow testing strategy from docs/architecture/testing-strategy.md:

- Unit tests for history operations and storage
- Integration tests for CLI history interaction
- E2E tests for complete history workflow
- Test history limits, export formats, and session management

### Technical Constraints

- Use Go standard library for in-memory storage
- Follow coding standards from docs/architecture/coding-standards.md
- History size configurable via Configuration model
- Export formats: JSON, CSV, plain text
- Thread-safe operations for concurrent access

## Tasks / Subtasks

- [ ] Implement History and Calculation models in internal/models/
  - [ ] Create history.go with History struct and methods
  - [ ] Create calculation.go with Calculation struct and methods
  - [ ] Add JSON marshaling/unmarshaling support

- [ ] Implement history storage in internal/history/storage.go
  - [ ] Create Storage interface for history operations
  - [ ] Implement in-memory storage with size limits
  - [ ] Add persistence to file system
  - [ ] Implement thread-safe operations

- [ ] Implement history manager in internal/history/manager.go
  - [ ] Create HistoryManager struct with storage integration
  - [ ] Implement AddCalculation, GetHistory, ClearHistory methods
  - [ ] Add export functionality (JSON, CSV, text)
  - [ ] Integrate with Configuration for size limits

- [ ] Integrate history with calculation engine in internal/calculation/engine.go
  - [ ] Extend CalculationEngine to include history manager
  - [ ] Automatically add calculations to history
  - [ ] Handle history errors gracefully

- [ ] Implement CLI history commands in internal/terminal/cli.go
  - [ ] Add "history" command to display recent calculations
  - [ ] Add "history clear" to reset session
  - [ ] Add "history export <format>" for data export
  - [ ] Integrate with existing CLI prompt system

- [ ] Add history display formatting in internal/terminal/history.go
  - [ ] Format history entries with timestamps and expressions
  - [ ] Implement pagination for large histories
  - [ ] Add colorized output for better readability

- [ ] Create comprehensive history tests
  - [ ] Unit tests for storage operations
  - [ ] Unit tests for manager functionality
  - [ ] Integration tests for CLI history commands
  - [ ] E2E tests for complete history workflow

## Testing

- Unit tests: History storage, manager operations, model validation
- Integration tests: CLI history interaction with calculation engine
- E2E tests: Complete user workflow with history navigation
- Edge cases: History limits, export formats, concurrent access
- Follow testing examples from docs/architecture/testing-strategy.md

## Dev Agent Record

### Agent Model Used

SM (Scrum Master) - Story Preparation Specialist

### Debug Log References

- History implementation following data-models.md and backend-architecture.md
- Integration with existing CLI from Story 1.3
- Session management and persistence patterns

### Completion Notes

- Calculation history system implemented with session tracking
- CLI enhanced with history display, navigation, and export
- Comprehensive testing covering all history operations
- Integration with calculation engine for automatic tracking
- Configurable history limits and export formats

### File List

- internal/models/history.go (new)
- internal/models/calculation.go (new)
- internal/history/manager.go (new)
- internal/history/storage.go (new)
- internal/terminal/history.go (new)
- internal/calculation/engine.go (modified)
- internal/terminal/cli.go (modified)
- test/unit/history/manager_test.go (new)
- test/unit/history/storage_test.go (new)
- test/integration/history_test.go (new)
- test/e2e/history_test.go (new)

### Change Log

- 2025-01-12: Initial story creation with history requirements and technical context from architecture documents

## Status: Draft