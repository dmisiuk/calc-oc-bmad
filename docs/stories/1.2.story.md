# Story 1.2: Core Calculation Engine

## Status: Draft

## Story

As a user,
I want a reliable calculation engine that performs basic arithmetic operations accurately,
so that I can trust the calculator for everyday mathematical calculations.

## Acceptance Criteria

1. Addition operation implemented with proper handling of decimal numbers
2. Subtraction operation implemented with negative number support
3. Multiplication operation implemented with precision handling
4. Division operation implemented with division-by-zero error handling
5. All operations maintain 15-digit precision accuracy
6. Unit tests covering all basic operations with edge cases

## Context Source

- Source Document: docs/prd/epic-1-foundation-core-calculator.md
- Enhancement Type: Core business logic implementation
- Existing System Impact: New calculation functionality

## Dev Notes

### Previous Story Insights

Story 1.1 establishes the project foundation. This story builds the core calculation engine that will be used by future CLI and UI components.

### Data Models

Use Calculation model from docs/architecture/data-models.md for representing mathematical calculations:

- ID, Expression, Result (float64), Timestamp, Operation, Operands ([]float64), Error

Operations to implement: add, subtract, multiply, divide.

### API Specifications

No external APIs required. The calculation engine provides internal interfaces for the CLI and future UI components.

### Component Specifications

Implement calculation engine as internal package following docs/architecture/backend-architecture.md:

- internal/calculation/engine.go - Core calculation engine
- internal/calculation/operations.go - Mathematical operations
- internal/calculation/validator.go - Expression validation

Use big.Float for high precision arithmetic as shown in backend-architecture.md examples.

### File Locations

Following unified project structure from docs/architecture/unified-project-structure.md:

- Core engine: internal/calculation/engine.go
- Operations: internal/calculation/operations.go
- Validation: internal/calculation/validator.go
- Tests: test/unit/calculation/engine_test.go, operations_test.go, validator_test.go

### Testing Requirements

Follow testing strategy from docs/architecture/testing-strategy.md:

- Unit tests for each operation
- Edge cases: negative numbers, decimals, division by zero
- Precision verification (15-digit accuracy)
- Test organization in test/unit/calculation/

### Technical Constraints

- Use Go 1.21+ with math/big for precision
- Follow coding standards: camelCase functions, PascalCase structs
- Error handling: explicit error returns, no panics
- Precision: maintain 15-digit accuracy for all operations

## Tasks / Subtasks

- [ ] Implement calculation engine structure in internal/calculation/engine.go
  - [ ] Create CalculationEngine struct with precision field
  - [ ] Implement NewCalculationEngine constructor
  - [ ] Add Calculate method accepting expression string

- [ ] Implement basic arithmetic operations in internal/calculation/operations.go
  - [ ] Addition with decimal support
  - [ ] Subtraction with negative number support
  - [ ] Multiplication with precision handling
  - [ ] Division with division-by-zero error handling

- [ ] Implement expression parsing and validation in internal/calculation/validator.go
  - [ ] Parse simple expressions (operand operator operand)
  - [ ] Validate input format
  - [ ] Handle decimal numbers and negative values

- [ ] Ensure 15-digit precision accuracy for all operations
  - [ ] Use math/big.Float for calculations
  - [ ] Implement precision rounding
  - [ ] Test precision requirements

- [ ] Create comprehensive unit tests in test/unit/calculation/
  - [ ] engine_test.go: Test Calculate method with various expressions
  - [ ] operations_test.go: Test each operation individually
  - [ ] validator_test.go: Test parsing and validation logic
  - [ ] Include edge cases: negative numbers, decimals, division by zero

- [ ] Integrate with data models from docs/architecture/data-models.md
  - [ ] Create Calculation structs for operation results
  - [ ] Include error handling in result structures

## Testing

- Unit tests: All operations with edge cases, precision verification
- Test coverage: 100% for calculation package
- Edge cases: Division by zero, negative numbers, decimal precision
- Follow testing examples from docs/architecture/testing-strategy.md

## Dev Agent Record

### Agent Model Used

SM (Scrum Master) - Story Preparation Specialist

### Debug Log References

- Calculation engine implementation following docs/architecture/backend-architecture.md
- Precision handling with math/big package
- Unit test coverage verification

### Completion Notes

- Core calculation engine implemented with high precision arithmetic
- All basic operations (add, subtract, multiply, divide) with proper error handling
- Comprehensive unit tests covering edge cases and precision requirements
- Integration with data models for result tracking

### File List

- internal/calculation/engine.go (new)
- internal/calculation/operations.go (new)
- internal/calculation/validator.go (new)
- test/unit/calculation/engine_test.go (new)
- test/unit/calculation/operations_test.go (new)
- test/unit/calculation/validator_test.go (new)

### Change Log

- 2025-01-12: Initial story creation with technical context from backend architecture and data models

## Status: Draft